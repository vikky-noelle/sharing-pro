"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const export_ref_1 = require("./export-ref");
const file_system_engine_host_base_1 = require("./file-system-engine-host-base");
const path_1 = require("path");
const fs_1 = require("fs");
const file_system_utility_1 = require("./file-system-utility");
/**
 * A simple EngineHost that uses a registry of {name => path} to find collections. This can be
 * useful for tooling that want to load generic collections from random places.
 */
class RegistryEngineHost extends file_system_engine_host_base_1.FileSystemEngineHostBase {
    constructor() {
        super(...arguments);
        this._registry = new Map();
    }
    registerPath(path) {
        // Read the collection from the path.
        if (fs_1.existsSync(path) && fs_1.statSync(path).isFile()) {
            // Allow path to be fully qualified to a JSON file.
        }
        else if (fs_1.existsSync(path_1.join(path, 'collection.json')) && fs_1.statSync(path).isFile()) {
            // Allow path to point to a directory containing a `collection.json`.
            path = path_1.join(path, 'collection.json');
        }
        else {
            throw new Error(`Invalid path: "${path}".`);
        }
        const json = file_system_utility_1.readJsonFile(path);
        if (!json) {
            throw new Error(`Invalid path for collection: "${path}".`);
        }
        // Validate that the name is not in the registry already (and that the registry does not
        // contain this path under another name.
        const name = json.name;
        const maybePath = this._registry.get(name);
        if (maybePath && maybePath != path) {
            throw new Error(`Collection name "${name}" already registered.`);
        }
        for (const registryPath of this._registry.values()) {
            if (registryPath == path) {
                throw new Error(`Collection path "${path}" already registered under another name.`);
            }
        }
        this._registry.set(name, path);
    }
    removePath(path) {
        for (const [key, p] of this._registry.entries()) {
            if (p == path) {
                this._registry.delete(key);
            }
        }
    }
    removeName(name) {
        this._registry.delete(name);
    }
    _resolveCollectionPath(name) {
        const maybePath = this._registry.get(name);
        return maybePath || null;
    }
    _resolveReferenceString(refString, parentPath) {
        // Use the same kind of export strings as NodeModule.
        const ref = new export_ref_1.ExportStringRef(refString, parentPath);
        return { ref: ref.ref, path: ref.module };
    }
    _transformCollectionDescription(_name, desc) {
        if (!desc.name || !desc.path || !desc.schematics || !desc.version) {
            return null;
        }
        if (typeof desc.schematics != 'object') {
            return null;
        }
        return desc;
    }
    _transformSchematicDescription(_name, _collection, desc) {
        if (!desc.factoryFn || !desc.path || !desc.description) {
            return null;
        }
        return desc;
    }
}
exports.RegistryEngineHost = RegistryEngineHost;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0cnktZW5naW5lLWhvc3QuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2hhbnNsL1NvdXJjZXMvZGV2a2l0LyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvc2NoZW1hdGljc190b29scy9zcmMvcmVnaXN0cnktZW5naW5lLWhvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7O0dBTUc7QUFDSCw2Q0FBNkM7QUFFN0MsaUZBQXdFO0FBUXhFLCtCQUEwQjtBQUMxQiwyQkFBd0M7QUFDeEMsK0RBQW1EO0FBY25EOzs7R0FHRztBQUNILHdCQUFnQyxTQUFRLHVEQUF3QjtJQUFoRTs7UUFDWSxjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7SUE4RWxELENBQUM7SUE1RUMsWUFBWSxDQUFDLElBQVk7UUFDdkIscUNBQXFDO1FBRXJDLEVBQUUsQ0FBQyxDQUFDLGVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxhQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hELG1EQUFtRDtRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLGVBQVUsQ0FBQyxXQUFJLENBQUMsSUFBSSxFQUFFLGlCQUFpQixDQUFDLENBQUMsSUFBSSxhQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2hGLHFFQUFxRTtZQUNyRSxJQUFJLEdBQUcsV0FBSSxDQUFDLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELE1BQU0sSUFBSSxHQUE2QixrQ0FBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENB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QztRQUNkLENBQUM7UUFDRCxNQUFNLENBQTBCLElBQUksQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUEvRUQsZ0RBK0VDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHtFeHBvcnRTdHJpbmdSZWZ9IGZyb20gJy4vZXhwb3J0LXJlZic7XG5pbXBvcnQge0ZpbGVTeXN0ZW1Db2xsZWN0aW9uRGVzY3JpcHRpb24sIEZpbGVTeXN0ZW1TY2hlbWF0aWNEZXNjcmlwdGlvbn0gZnJvbSAnLi9kZXNjcmlwdGlvbic7XG5pbXBvcnQge0ZpbGVTeXN0ZW1FbmdpbmVIb3N0QmFzZX0gZnJvbSAnLi9maWxlLXN5c3RlbS1lbmdpbmUtaG9zdC1iYXNlJztcblxuaW1wb3J0IHtcbiAgQ29sbGVjdGlvbkRlc2NyaXB0aW9uLFxuICBSdWxlRmFjdG9yeSxcbiAgU2NoZW1hdGljRGVzY3JpcHRpb24sXG59IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcblxuaW1wb3J0IHtqb2lufSBmcm9tICdwYXRoJztcbmltcG9ydCB7ZXhpc3RzU3luYywgc3RhdFN5bmN9IGZyb20gJ2ZzJztcbmltcG9ydCB7cmVhZEpzb25GaWxlfSBmcm9tICcuL2ZpbGUtc3lzdGVtLXV0aWxpdHknO1xuXG5cblxuLyoqXG4gKiBVc2VkIHRvIHNpbXBsaWZ5IHR5cGluZ3MuXG4gKi9cbmV4cG9ydCBkZWNsYXJlIHR5cGUgRmlsZVN5c3RlbUNvbGxlY3Rpb25EZXNjXG4gID0gQ29sbGVjdGlvbkRlc2NyaXB0aW9uPEZpbGVTeXN0ZW1Db2xsZWN0aW9uRGVzY3JpcHRpb24+O1xuZXhwb3J0IGRlY2xhcmUgdHlwZSBGaWxlU3lzdGVtU2NoZW1hdGljRGVzY1xuICA9IFNjaGVtYXRpY0Rlc2NyaXB0aW9uPEZpbGVTeXN0ZW1Db2xsZWN0aW9uRGVzY3JpcHRpb24sIEZpbGVTeXN0ZW1TY2hlbWF0aWNEZXNjcmlwdGlvbj47XG5cblxuXG4vKipcbiAqIEEgc2ltcGxlIEVuZ2luZUhvc3QgdGhhdCB1c2VzIGEgcmVnaXN0cnkgb2Yge25hbWUgPT4gcGF0aH0gdG8gZmluZCBjb2xsZWN0aW9ucy4gVGhpcyBjYW4gYmVcbiAqIHVzZWZ1bCBmb3IgdG9vbGluZyB0aGF0IHdhbnQgdG8gbG9hZCBnZW5lcmljIGNvbGxlY3Rpb25zIGZyb20gcmFuZG9tIHBsYWNlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFJlZ2lzdHJ5RW5naW5lSG9zdCBleHRlbmRzIEZpbGVTeXN0ZW1FbmdpbmVIb3N0QmFzZSB7XG4gIHByb3RlY3RlZCBfcmVnaXN0cnkgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG4gIHJlZ2lzdGVyUGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBSZWFkIHRoZSBjb2xsZWN0aW9uIGZyb20gdGhlIHBhdGguXG5cbiAgICBpZiAoZXhpc3RzU3luYyhwYXRoKSAmJiBzdGF0U3luYyhwYXRoKS5pc0ZpbGUoKSkge1xuICAgICAgLy8gQWxsb3cgcGF0aCB0byBiZSBmdWxseSBxdWFsaWZpZWQgdG8gYSBKU09OIGZpbGUuXG4gICAgfSBlbHNlIGlmIChleGlzdHNTeW5jKGpvaW4ocGF0aCwgJ2NvbGxlY3Rpb24uanNvbicpKSAmJiBzdGF0U3luYyhwYXRoKS5pc0ZpbGUoKSkge1xuICAgICAgLy8gQWxsb3cgcGF0aCB0byBwb2ludCB0byBhIGRpcmVjdG9yeSBjb250YWluaW5nIGEgYGNvbGxlY3Rpb24uanNvbmAuXG4gICAgICBwYXRoID0gam9pbihwYXRoLCAnY29sbGVjdGlvbi5qc29uJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYXRoOiBcIiR7cGF0aH1cIi5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBqc29uOiBGaWxlU3lzdGVtQ29sbGVjdGlvbkRlc2MgPSByZWFkSnNvbkZpbGUocGF0aCk7XG4gICAgaWYgKCFqc29uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBmb3IgY29sbGVjdGlvbjogXCIke3BhdGh9XCIuYCk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgdGhhdCB0aGUgbmFtZSBpcyBub3QgaW4gdGhlIHJlZ2lzdHJ5IGFscmVhZHkgKGFuZCB0aGF0IHRoZSByZWdpc3RyeSBkb2VzIG5vdFxuICAgIC8vIGNvbnRhaW4gdGhpcyBwYXRoIHVuZGVyIGFub3RoZXIgbmFtZS5cbiAgICBjb25zdCBuYW1lID0ganNvbi5uYW1lO1xuICAgIGNvbnN0IG1heWJlUGF0aCA9IHRoaXMuX3JlZ2lzdHJ5LmdldChuYW1lKTtcbiAgICBpZiAobWF5YmVQYXRoICYmIG1heWJlUGF0aCAhPSBwYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbGxlY3Rpb24gbmFtZSBcIiR7bmFtZX1cIiBhbHJlYWR5IHJlZ2lzdGVyZWQuYCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgcmVnaXN0cnlQYXRoIG9mIHRoaXMuX3JlZ2lzdHJ5LnZhbHVlcygpKSB7XG4gICAgICBpZiAocmVnaXN0cnlQYXRoID09IHBhdGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb2xsZWN0aW9uIHBhdGggXCIke3BhdGh9XCIgYWxyZWFkeSByZWdpc3RlcmVkIHVuZGVyIGFub3RoZXIgbmFtZS5gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl9yZWdpc3RyeS5zZXQobmFtZSwgcGF0aCk7XG4gIH1cblxuICByZW1vdmVQYXRoKHBhdGg6IHN0cmluZykge1xuICAgIGZvciAoY29uc3QgW2tleSwgcF0gb2YgdGhpcy5fcmVnaXN0cnkuZW50cmllcygpKSB7XG4gICAgICBpZiAocCA9PSBwYXRoKSB7XG4gICAgICAgIHRoaXMuX3JlZ2lzdHJ5LmRlbGV0ZShrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZU5hbWUobmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fcmVnaXN0cnkuZGVsZXRlKG5hbWUpO1xuICB9XG5cblxuICBwcm90ZWN0ZWQgX3Jlc29sdmVDb2xsZWN0aW9uUGF0aChuYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBtYXliZVBhdGggPSB0aGlzLl9yZWdpc3RyeS5nZXQobmFtZSk7XG4gICAgcmV0dXJuIG1heWJlUGF0aCB8fCBudWxsO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9yZXNvbHZlUmVmZXJlbmNlU3RyaW5nKHJlZlN0cmluZzogc3RyaW5nLCBwYXJlbnRQYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBVc2UgdGhlIHNhbWUga2luZCBvZiBleHBvcnQgc3RyaW5ncyBhcyBOb2RlTW9kdWxlLlxuICAgIGNvbnN0IHJlZiA9IG5ldyBFeHBvcnRTdHJpbmdSZWY8UnVsZUZhY3Rvcnk8YW55Pj4ocmVmU3RyaW5nLCBwYXJlbnRQYXRoKTtcbiAgICByZXR1cm4geyByZWY6IHJlZi5yZWYsIHBhdGg6IHJlZi5tb2R1bGUgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdHJhbnNmb3JtQ29sbGVjdGlvbkRlc2NyaXB0aW9uKF9uYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2M6IFBhcnRpYWw8RmlsZVN5c3RlbUNvbGxlY3Rpb25EZXNjPikge1xuICAgIGlmICghZGVzYy5uYW1lIHx8ICFkZXNjLnBhdGggfHwgIWRlc2Muc2NoZW1hdGljcyB8fCAhZGVzYy52ZXJzaW9uKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkZXNjLnNjaGVtYXRpY3MgIT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gPEZpbGVTeXN0ZW1Db2xsZWN0aW9uRGVzYz5kZXNjO1xuICB9XG5cbiAgcHJvdGVjdGVkIF90cmFuc2Zvcm1TY2hlbWF0aWNEZXNjcmlwdGlvbihfbmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb2xsZWN0aW9uOiBGaWxlU3lzdGVtQ29sbGVjdGlvbkRlc2MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzYzogUGFydGlhbDxGaWxlU3lzdGVtU2NoZW1hdGljRGVzYz4pIHtcbiAgICBpZiAoIWRlc2MuZmFjdG9yeUZuIHx8ICFkZXNjLnBhdGggfHwgIWRlc2MuZGVzY3JpcHRpb24pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gPEZpbGVTeXN0ZW1TY2hlbWF0aWNEZXNjPmRlc2M7XG4gIH1cbn1cblxuIl19