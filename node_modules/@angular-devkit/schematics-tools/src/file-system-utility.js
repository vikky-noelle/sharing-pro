"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const fs_1 = require("fs");
/**
 * Read a file and returns its content. This supports different file encoding.
 */
function readFile(fileName) {
    if (!fs_1.existsSync(fileName)) {
        return null;
    }
    const buffer = fs_1.readFileSync(fileName);
    let len = buffer.length;
    if (len >= 2 && buffer[0] === 0xFE && buffer[1] === 0xFF) {
        // Big endian UTF-16 byte order mark detected. Since big endian is not supported by node.js,
        // flip all byte pairs and treat as little endian.
        len &= ~1;
        for (let i = 0; i < len; i += 2) {
            const temp = buffer[i];
            buffer[i] = buffer[i + 1];
            buffer[i + 1] = temp;
        }
        return buffer.toString('utf16le', 2);
    }
    if (len >= 2 && buffer[0] === 0xFF && buffer[1] === 0xFE) {
        // Little endian UTF-16 byte order mark detected
        return buffer.toString('utf16le', 2);
    }
    if (len >= 3 && buffer[0] === 0xEF && buffer[1] === 0xBB && buffer[2] === 0xBF) {
        // UTF-8 byte order mark detected
        return buffer.toString('utf8', 3);
    }
    // Default is UTF-8 with no byte order mark
    return buffer.toString('utf8');
}
exports.readFile = readFile;
/**
 * Parse a JSON string and optionally remove comments from it first.
 */
function parseJson(content, stripComments = true) {
    if (stripComments) {
        // Simple parser to ignore strings.
        let inString = false;
        for (let i = 0; i < content.length; i++) {
            if (inString) {
                // Skip `\X` characters. Since we only care about \", we don't need to fully process valid
                // escape sequences (e.g. unicode sequences). This algorithm could accept invalid sequences
                // but the JSON.parse call will throw on those so the output of the whole function will
                // still be valid.
                switch (content[i]) {
                    case '\\':
                        i++;
                        break;
                    case '"':
                        inString = false;
                        break;
                }
            }
            else {
                switch (content[i]) {
                    case '"':
                        inString = true;
                        break;
                    case '/':
                        let j = 0;
                        switch (content[i + 1]) {
                            case '/':
                                for (j = i + 2; j < content.length; j++) {
                                    if (content[j] == '\n' || content[j] == '\r') {
                                        break;
                                    }
                                }
                                break;
                            case '*':
                                for (j = i + 2; j < content.length; j++) {
                                    if (content[j - 1] == '*' && content[j] == '/') {
                                        break;
                                    }
                                }
                                break;
                        }
                        if (j) {
                            // Use `j + 1` to skip the end-of-comment character.
                            content = content.substr(0, i) + content.substr(j + 1);
                            i--;
                        }
                        break;
                }
            }
        }
        // At this point we don't really care about the validity of the resulting string, since
        // JSON.parse will validate the JSON itself.
    }
    return JSON.parse(content);
}
exports.parseJson = parseJson;
function readJsonFile(path) {
    return parseJson(readFile(path) || '{}');
}
exports.readJsonFile = readJsonFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1zeXN0ZW0tdXRpbGl0eS5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvaGFuc2wvU291cmNlcy9kZXZraXQvIiwic291cmNlcyI6WyJwYWNrYWdlcy9hbmd1bGFyX2RldmtpdC9zY2hlbWF0aWNzX3Rvb2xzL3NyYy9maWxlLXN5c3RlbS11dGlsaXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsMkJBQTRDO0FBRzVDOztHQUVHO0FBQ0gsa0JBQXlCLFFBQWdCO0lBQ3ZDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNELE1BQU0sTUFBTSxHQUFHLGlCQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEMsSUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUN4QixFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekQsNEZBQTRGO1FBQzVGLGtEQUFrRDtRQUNsRCxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDVixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDaEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxD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RyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO3dDQUMvQyxLQUFLLENBQUM7b0NBQ1IsQ0FBQztnQ0FDSCxDQUFDO2dDQUNELEtBQUssQ0FBQzt3QkFDVixDQUFDO3dCQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ04sb0RBQW9EOzRCQUNwRCxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQ3ZELENBQUMsRUFBRSxDQUFDO3dCQUNOLENBQUM7d0JBQ0QsS0FBSyxDQUFDO2dCQUNWLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUNELHVGQUF1RjtRQUN2Riw0Q0FBNEM7SUFDOUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFsREQsOEJBa0RDO0FBR0Qsc0JBQTZCLElBQVk7SUFDdkMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUZELG9DQUVDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHtleGlzdHNTeW5jLCByZWFkRmlsZVN5bmN9IGZyb20gJ2ZzJztcblxuXG4vKipcbiAqIFJlYWQgYSBmaWxlIGFuZCByZXR1cm5zIGl0cyBjb250ZW50LiBUaGlzIHN1cHBvcnRzIGRpZmZlcmVudCBmaWxlIGVuY29kaW5nLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICBpZiAoIWV4aXN0c1N5bmMoZmlsZU5hbWUpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgY29uc3QgYnVmZmVyID0gcmVhZEZpbGVTeW5jKGZpbGVOYW1lKTtcbiAgbGV0IGxlbiA9IGJ1ZmZlci5sZW5ndGg7XG4gIGlmIChsZW4gPj0gMiAmJiBidWZmZXJbMF0gPT09IDB4RkUgJiYgYnVmZmVyWzFdID09PSAweEZGKSB7XG4gICAgLy8gQmlnIGVuZGlhbiBVVEYtMTYgYnl0ZSBvcmRlciBtYXJrIGRldGVjdGVkLiBTaW5jZSBiaWcgZW5kaWFuIGlzIG5vdCBzdXBwb3J0ZWQgYnkgbm9kZS5qcyxcbiAgICAvLyBmbGlwIGFsbCBieXRlIHBhaXJzIGFuZCB0cmVhdCBhcyBsaXR0bGUgZW5kaWFuLlxuICAgIGxlbiAmPSB+MTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7XG4gICAgICBjb25zdCB0ZW1wID0gYnVmZmVyW2ldO1xuICAgICAgYnVmZmVyW2ldID0gYnVmZmVyW2kgKyAxXTtcbiAgICAgIGJ1ZmZlcltpICsgMV0gPSB0ZW1wO1xuICAgIH1cbiAgICByZXR1cm4gYnVmZmVyLnRvU3RyaW5nKCd1dGYxNmxlJywgMik7XG4gIH1cbiAgaWYgKGxlbiA+PSAyICYmIGJ1ZmZlclswXSA9PT0gMHhGRiAmJiBidWZmZXJbMV0gPT09IDB4RkUpIHtcbiAgICAvLyBMaXR0bGUgZW5kaWFuIFVURi0xNiBieXRlIG9yZGVyIG1hcmsgZGV0ZWN0ZWRcbiAgICByZXR1cm4gYnVmZmVyLnRvU3RyaW5nKCd1dGYxNmxlJywgMik7XG4gIH1cbiAgaWYgKGxlbiA+PSAzICYmIGJ1ZmZlclswXSA9PT0gMHhFRiAmJiBidWZmZXJbMV0gPT09IDB4QkIgJiYgYnVmZmVyWzJdID09PSAweEJGKSB7XG4gICAgLy8gVVRGLTggYnl0ZSBvcmRlciBtYXJrIGRldGVjdGVkXG4gICAgcmV0dXJuIGJ1ZmZlci50b1N0cmluZygndXRmOCcsIDMpO1xuICB9XG4gIC8vIERlZmF1bHQgaXMgVVRGLTggd2l0aCBubyBieXRlIG9yZGVyIG1hcmtcbiAgcmV0dXJuIGJ1ZmZlci50b1N0cmluZygndXRmOCcpO1xufVxuXG5cbi8qKlxuICogUGFyc2UgYSBKU09OIHN0cmluZyBhbmQgb3B0aW9uYWxseSByZW1vdmUgY29tbWVudHMgZnJvbSBpdCBmaXJzdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlSnNvbihjb250ZW50OiBzdHJpbmcsIHN0cmlwQ29tbWVudHMgPSB0cnVlKTogYW55IHtcbiAgaWYgKHN0cmlwQ29tbWVudHMpIHtcbiAgICAvLyBTaW1wbGUgcGFyc2VyIHRvIGlnbm9yZSBzdHJpbmdzLlxuICAgIGxldCBpblN0cmluZyA9IGZhbHNlO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29udGVudC5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGluU3RyaW5nKSB7XG4gICAgICAgIC8vIFNraXAgYFxcWGAgY2hhcmFjdGVycy4gU2luY2Ugd2Ugb25seSBjYXJlIGFib3V0IFxcXCIsIHdlIGRvbid0IG5lZWQgdG8gZnVsbHkgcHJvY2VzcyB2YWxpZFxuICAgICAgICAvLyBlc2NhcGUgc2VxdWVuY2VzIChlLmcuIHVuaWNvZGUgc2VxdWVuY2VzKS4gVGhpcyBhbGdvcml0aG0gY291bGQgYWNjZXB0IGludmFsaWQgc2VxdWVuY2VzXG4gICAgICAgIC8vIGJ1dCB0aGUgSlNPTi5wYXJzZSBjYWxsIHdpbGwgdGhyb3cgb24gdGhvc2Ugc28gdGhlIG91dHB1dCBvZiB0aGUgd2hvbGUgZnVuY3Rpb24gd2lsbFxuICAgICAgICAvLyBzdGlsbCBiZSB2YWxpZC5cbiAgICAgICAgc3dpdGNoIChjb250ZW50W2ldKSB7XG4gICAgICAgICAgY2FzZSAnXFxcXCc6IGkrKzsgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnXCInOiBpblN0cmluZyA9IGZhbHNlOyBicmVhaztcbiAgICAgICAgICAvLyBFbHNlIGlnbm9yZSBjaGFyYWN0ZXJzLlxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzd2l0Y2ggKGNvbnRlbnRbaV0pIHtcbiAgICAgICAgICBjYXNlICdcIic6IGluU3RyaW5nID0gdHJ1ZTsgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnLyc6XG4gICAgICAgICAgICBsZXQgaiA9IDA7XG4gICAgICAgICAgICBzd2l0Y2ggKGNvbnRlbnRbaSArIDFdKSB7XG4gICAgICAgICAgICAgIGNhc2UgJy8nOiAgLy8gU3RyaXAgdW50aWwgZW5kLW9mLWxpbmUuXG4gICAgICAgICAgICAgICAgZm9yIChqID0gaSArIDI7IGogPCBjb250ZW50Lmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoY29udGVudFtqXSA9PSAnXFxuJyB8fCBjb250ZW50W2pdID09ICdcXHInKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgY2FzZSAnKic6ICAvLyBTdHJpcCB1bnRpbCBgKi9gLlxuICAgICAgICAgICAgICAgIGZvciAoaiA9IGkgKyAyOyBqIDwgY29udGVudC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRbaiAtIDFdID09ICcqJyAmJiBjb250ZW50W2pdID09ICcvJykge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaikge1xuICAgICAgICAgICAgICAvLyBVc2UgYGogKyAxYCB0byBza2lwIHRoZSBlbmQtb2YtY29tbWVudCBjaGFyYWN0ZXIuXG4gICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnN1YnN0cigwLCBpKSArIGNvbnRlbnQuc3Vic3RyKGogKyAxKTtcbiAgICAgICAgICAgICAgaS0tO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8gQXQgdGhpcyBwb2ludCB3ZSBkb24ndCByZWFsbHkgY2FyZSBhYm91dCB0aGUgdmFsaWRpdHkgb2YgdGhlIHJlc3VsdGluZyBzdHJpbmcsIHNpbmNlXG4gICAgLy8gSlNPTi5wYXJzZSB3aWxsIHZhbGlkYXRlIHRoZSBKU09OIGl0c2VsZi5cbiAgfVxuXG4gIHJldHVybiBKU09OLnBhcnNlKGNvbnRlbnQpO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkSnNvbkZpbGUocGF0aDogc3RyaW5nKTogYW55IHtcbiAgcmV0dXJuIHBhcnNlSnNvbihyZWFkRmlsZShwYXRoKSB8fCAne30nKTtcbn1cbiJdfQ==